+++
id = "TASK-TS-20250831-071400"
title = "Migrate Visual Search Function to Use Enhanced MIVAA Services"
status = "ðŸŸ¢ Done"
type = "ðŸ”§ Migration"
assigned_to = "util-typescript"
coordinator = "TASK-ARCH-20250830-172000"
priority = "high"
estimated_effort = "medium"
created_date = "2025-08-31T07:14:00Z"
updated_date = "2025-08-31T07:20:00Z"
related_docs = [
    "supabase/functions/visual-search/index.ts",
    "supabase/functions/_shared/embedding-utils.ts",
    "src/services/mivaaEmbeddingIntegration.ts",
    ".roopm/tasks/ARCHITECTURE_MIVAA_Integration_Cleanup/SUPABASE_EMBEDDING_COORDINATION_STRATEGY.md"
]
tags = ["migration", "visual-search", "mivaa", "supabase", "typescript"]
dependencies = ["TASK-PY-20250831-051700"]
blocking = []
+++

# Migrate Visual Search Function to Use Enhanced MIVAA Services

## Description

**Critical Migration Task**: Replace direct AI API calls in the visual search function with enhanced MIVAA services to centralize AI operations while preserving all functionality.

**Context**: The 867-line visual search pipeline currently makes direct calls to TogetherAI, OpenAI, and CLIP. We have enhanced existing services ([`supabase/functions/_shared/embedding-utils.ts`](supabase/functions/_shared/embedding-utils.ts) and [`src/services/mivaaEmbeddingIntegration.ts`](src/services/mivaaEmbeddingIntegration.ts)) to route through MIVAA gateway instead of creating new services.

**Goal**: Zero functionality loss while achieving centralized AI management through MIVAA.

## Acceptance Criteria

- [âœ…] TogetherAI/LLaMA Vision calls replaced with [`generateSemanticAnalysis()`](supabase/functions/_shared/embedding-utils.ts)
- [âœ…] OpenAI embedding calls replaced with [`generateStandardEmbedding()`](supabase/functions/_shared/embedding-utils.ts)
- [âœ…] CLIP embedding logic updated to use MIVAA (if applicable)
- [âœ…] All database operations and pgVector calls preserved unchanged
- [âœ…] Environment variables updated for MIVAA configuration
- [âœ…] End-to-end visual search functionality verified
- [âœ…] No regression in search performance or accuracy

## Technical Requirements

**Enhanced Services to Use:**

1. **Existing Enhanced Embedding Utils**: [`supabase/functions/_shared/embedding-utils.ts`](supabase/functions/_shared/embedding-utils.ts)
   - `generateStandardEmbedding()` - Routes through MIVAA gateway
   - `generateSemanticAnalysis()` - New function for LLaMA Vision analysis

2. **Existing Enhanced MIVAA Integration**: [`src/services/mivaaEmbeddingIntegration.ts`](src/services/mivaaEmbeddingIntegration.ts)
   - `generateSemanticAnalysis()` - For reference patterns

**Target Functions to Replace:**

1. **Lines 650-699**: [`generateSemanticDescription()`](supabase/functions/visual-search/index.ts:650)
   - **BEFORE**: Direct TogetherAI API calls
   - **AFTER**: Use [`generateSemanticAnalysis()`](supabase/functions/_shared/embedding-utils.ts) from enhanced utilities

2. **Lines 701-732**: [`generateTextEmbedding()`](supabase/functions/visual-search/index.ts:701)
   - **BEFORE**: Direct OpenAI API calls  
   - **AFTER**: Use [`generateStandardEmbedding()`](supabase/functions/_shared/embedding-utils.ts) from enhanced utilities

## Checklist

### Phase 1: Import Enhanced Services ðŸ“¦
- [âœ…] Import enhanced embedding utilities at top of visual search function
- [âœ…] Verify environment variables are configured for MIVAA gateway access
- [âœ…] Test connectivity to MIVAA gateway from Supabase environment

### Phase 2: Replace TogetherAI Integration ðŸ¤–
- [âœ…] Replace [`generateSemanticDescription()`](supabase/functions/visual-search/index.ts:650) implementation
- [âœ…] Use [`generateSemanticAnalysis()`](supabase/functions/_shared/embedding-utils.ts) function
- [âœ…] Maintain exact same prompt and temperature settings (0.1, max_tokens: 200)
- [âœ…] Preserve error handling and fallback logic

### Phase 3: Replace OpenAI Integration ðŸ§ 
- [âœ…] Replace [`generateTextEmbedding()`](supabase/functions/visual-search/index.ts:701) implementation
- [âœ…] Use [`generateStandardEmbedding()`](supabase/functions/_shared/embedding-utils.ts) function
- [âœ…] Ensure text-embedding-3-small model and 1536D dimensions maintained
- [âœ…] Preserve text truncation and error handling

### Phase 4: Environment Configuration ðŸ”§
- [âœ…] Add MIVAA environment variables to Supabase Edge Functions
- [âœ…] Update function imports to use enhanced utilities
- [âœ…] Remove legacy environment variable dependencies
- [âœ…] Test configuration validation

### Phase 5: Validation & Testing âœ…
- [âœ…] Test semantic analysis generation via MIVAA
- [âœ…] Test text embedding generation via MIVAA
- [âœ…] Verify all search types work: visual_similarity, semantic_analysis, hybrid
- [âœ…] Validate database operations unchanged (pgVector queries preserved)
- [âœ…] Performance testing compared to direct API approach

## Implementation Guide

**Replace Pattern Example:**

```typescript
// BEFORE (Direct TogetherAI)
private async generateSemanticDescription(imageData: string): Promise<string> {
  // 50+ lines of direct TogetherAI API calls
}

// AFTER (Enhanced MIVAA Utils)
private async generateSemanticDescription(imageData: string): Promise<string> {
  return await generateSemanticAnalysis(imageData, 'material_identification');
}
```

**Import Statement:**
```typescript
import { 
  generateStandardEmbedding, 
  generateSemanticAnalysis 
} from '../_shared/embedding-utils.ts';
```

**Environment Variables Required:**
```bash
MIVAA_GATEWAY_URL=https://your-app.vercel.app
MIVAA_API_KEY=your_mivaa_api_key
EMBEDDING_MODEL=text-embedding-3-small
EMBEDDING_DIMENSIONS=1536
```

## Database Operations Preservation

**CRITICAL**: All database operations MUST remain unchanged:
- pgVector RPC calls: `visual_material_search`
- Table queries: `material_visual_analysis`
- Similarity thresholds and result formatting
- Search analytics and logging

## Risk Assessment

**Low Risk**: Using enhanced existing services with established patterns and comprehensive error handling.

**Mitigation**: Thorough testing with fallback to original implementation if issues arise.

## Expected Outcome

Visual search function will operate identically but route AI operations through MIVAA for centralized management, completing the AI service consolidation while preserving all functionality and performance characteristics.