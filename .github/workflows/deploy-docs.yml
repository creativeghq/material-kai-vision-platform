name: üìö Deploy Documentation

on:
  push:
    branches: [main, master]
    paths:
      - 'docs/**'
      - '.github/workflows/deploy-docs-to-docusaurus.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no docs changes'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  actions: read
  pull-requests: write

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check_changes.outputs.should_run }}
    steps:
      - name: üîß Check for changes in docs folder
        id: check_changes
        run: |
          # Always run for manual triggers or force deploy
          if [ "${{ github.event.inputs.force_deploy }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Manual trigger or force deploy - will proceed with deployment"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # For push events, always run (since we have path filters in the workflow trigger)
          echo "Push event detected - will proceed with deployment"
          echo "should_run=true" >> $GITHUB_OUTPUT

  deploy-docs:
    needs: check_changes
    if: needs.check_changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: üîç Checkout Material Kai Vision Platform
        uses: actions/checkout@v4

      - name: üìã Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: üßπ Create directory structure
        run: |
          mkdir -p docs-temp/docs
          mkdir -p docs-temp/build

      - name: üìö Create simple documentation site
        run: |
          echo "üìö Creating simple documentation site..."

          # Create build directory
          mkdir -p docs-temp/build

          # Generate dynamic index.html based on actual files
          echo "Scanning docs folder for markdown files..."

          # Start building the index.html
          cat > docs-temp/build/index.html << 'HEADER'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Material Kai Vision Platform Documentation</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
                  .container { max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
                  h2 { color: #34495e; margin-top: 30px; }
                  .docs-list { margin-top: 30px; }
                  .doc-item { background: #f8f9fa; padding: 15px 20px; margin: 10px 0; border-radius: 6px; border-left: 4px solid #3498db; }
                  .doc-item a { color: #3498db; text-decoration: none; font-weight: 500; font-size: 16px; }
                  .doc-item a:hover { text-decoration: underline; }
                  .doc-item .description { color: #7f8c8d; font-size: 14px; margin-top: 5px; }
                  .api-links { display: flex; gap: 15px; margin-bottom: 30px; }
                  .api-link { background: #27ae60; color: white; padding: 12px 20px; border-radius: 6px; text-decoration: none; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  .api-link.redoc { background: #e74c3c; }
                  .stats { background: #ecf0f1; padding: 20px; border-radius: 6px; margin-bottom: 30px; }
                  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
                  .stat-item { text-align: center; }
                  .stat-value { font-size: 32px; font-weight: bold; color: #2c3e50; }
                  .stat-label { color: #7f8c8d; font-size: 14px; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>üöÄ Material Kai Vision Platform Documentation</h1>
                  <p style="color: #7f8c8d; font-size: 16px;">AI-powered material intelligence system - Complete documentation and API reference</p>

                  <div class="api-links">
                      <a href="https://v1api.materialshub.gr/docs" target="_blank" class="api-link">üì° API Docs (Swagger)</a>
                      <a href="https://v1api.materialshub.gr/redoc" target="_blank" class="api-link redoc">üìã ReDoc</a>
                  </div>

                  <div class="stats">
                      <div class="stats-grid">
                          <div class="stat-item">
                              <div class="stat-value">24</div>
                              <div class="stat-label">Documentation Files</div>
                          </div>
                          <div class="stat-item">
                              <div class="stat-value">113</div>
                              <div class="stat-label">API Endpoints</div>
                          </div>
                          <div class="stat-item">
                              <div class="stat-value">12</div>
                              <div class="stat-label">AI Models</div>
                          </div>
                          <div class="stat-item">
                              <div class="stat-value">5,000+</div>
                              <div class="stat-label">Active Users</div>
                          </div>
                      </div>
                  </div>

                  <h2>üìö Documentation Files</h2>
                  <div class="docs-list">
          HEADER

          # Generate links for all markdown files
          find docs -name "*.md" | sort | while read file; do
              filename=$(basename "$file" .md)
              filepath="${file#docs/}"
              htmlpath="${filepath%.md}.html"

              # Create friendly title from filename
              title=$(echo "$filename" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')

              echo "                      <div class=\"doc-item\">" >> docs-temp/build/index.html
              echo "                          <a href=\"$htmlpath\">$title</a>" >> docs-temp/build/index.html
              echo "                      </div>" >> docs-temp/build/index.html
          done

          # Close the HTML
          cat >> docs-temp/build/index.html << 'FOOTER'
                  </div>

                  <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #ecf0f1; color: #7f8c8d; text-align: center;">
                      <p><strong>Material Kai Vision Platform v2.1.0</strong></p>
                      <p>Last updated: $(date +"%Y-%m-%d %H:%M:%S UTC")</p>
                      <p>This documentation is automatically generated and deployed from the main repository.</p>
                  </div>
              </div>
          </body>
          </html>
          FOOTER

          echo "‚úÖ Dynamic index.html created with all available documentation files"

          # Convert all markdown files to HTML
          npm install -g marked

          # Process each markdown file
          find docs -name "*.md" | while read file; do
              # Get relative path and convert to HTML filename
              rel_path=${file#docs/}
              html_file="docs-temp/build/${rel_path%.md}.html"

              # Create directory if needed
              mkdir -p "$(dirname "$html_file")"

              # Convert markdown to HTML with basic styling
              cat > "$html_file" << 'HTMLSTART'
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Material Kai Vision Platform</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; line-height: 1.6; }
                  .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  h1, h2, h3 { color: #2c3e50; }
                  h1 { border-bottom: 3px solid #3498db; padding-bottom: 10px; }
                  code { background: #f1f2f6; padding: 2px 6px; border-radius: 3px; font-family: 'Monaco', 'Consolas', monospace; }
                  pre { background: #f1f2f6; padding: 15px; border-radius: 6px; overflow-x: auto; }
                  a { color: #3498db; text-decoration: none; }
                  a:hover { text-decoration: underline; }
                  .back-link { margin-bottom: 20px; }
                  .back-link a { background: #3498db; color: white; padding: 8px 16px; border-radius: 4px; }
                  table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                  th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                  th { background: #f8f9fa; }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="back-link"><a href="../index.html">‚Üê Back to Documentation Home</a></div>
          HTMLSTART

              # Convert markdown content and append
              marked "$file" >> "$html_file"

              # Close HTML
              echo '</div></body></html>' >> "$html_file"
          done

          # Create a proper README.md for GitHub with dynamic links
          cat > docs-temp/build/README.md << 'READMEHEADER'
          # üöÄ Material Kai Vision Platform Documentation

          Welcome to the Material Kai Vision Platform documentation site!

          ## üìñ View Documentation

          **[üìö Browse Full Documentation](https://basilakis.github.io/)**

          ## üîó Quick Links

          - **[üì° API Documentation](https://v1api.materialshub.gr/docs)** - Interactive Swagger API documentation (113 endpoints)
          - **[üìã ReDoc API](https://v1api.materialshub.gr/redoc)** - Alternative API documentation format

          ## üìä Platform Stats

          - **24** Comprehensive Documentation Files
          - **113** API Endpoints across **14** categories
          - **12** AI Models (Claude Sonnet 4.5, Haiku 4.5, GPT-5, Llama 4 Scout 17B Vision, CLIP, etc.)
          - **6** Embedding Types (text, visual, color, texture, application, multimodal)
          - **14-Stage** PDF Processing Pipeline with checkpoint recovery
          - **5,000+** Active Users
          - **99.5%+** Uptime

          ## üìã Available Documentation

          READMEHEADER

          # Generate dynamic list of all documentation files
          find docs -name "*.md" | sort | while read file; do
              filename=$(basename "$file" .md)
              filepath="${file#docs/}"
              htmlpath="${filepath%.md}.html"

              # Create friendly title from filename
              title=$(echo "$filename" | sed 's/-/ /g' | sed 's/\b\(.\)/\u\1/g')

              echo "- [$title](https://basilakis.github.io/$htmlpath)" >> docs-temp/build/README.md
          done

          # Add footer
          cat >> docs-temp/build/README.md << 'READMEFOOTER'

          ---

          ## üèóÔ∏è Architecture

          - **Frontend**: React + TypeScript + Vite (Vercel)
          - **Backend**: FastAPI + Python 3.11 (Docker)
          - **Database**: Supabase PostgreSQL with pgvector
          - **AI Services**: OpenAI, Anthropic, Together AI, Replicate
          - **Vector Search**: OpenAI embeddings (1536D), CLIP (512D)

          ## üöÄ Key Features

          - **PDF Processing**: 14-stage AI pipeline with checkpoint recovery and async job queuing
          - **Product Discovery**: AI-powered dynamic product identification with metadata extraction
          - **Document Entities**: Certificates, logos, specifications as separate knowledge base
          - **Multi-Vector Search**: 6 specialized embeddings (text, visual, color, texture, application, multimodal)
          - **Duplicate Detection**: Smart material deduplication with factory/manufacturer matching
          - **Search Suggestions**: AI-powered auto-complete, trending searches, and typo correction
          - **Material Recognition**: Llama 4 Scout 17B Vision (69.4% MMMU, #1 OCR performance)
          - **Prompt Enhancement**: Admin-configurable extraction prompts with version control
          - **Relevancy System**: Multi-source linking between chunks, images, and products

          ---

          **Material Kai Vision Platform v2.1.0** - AI-powered material intelligence system

          *This documentation is automatically generated and deployed from the main repository.*
          *Last updated: $(date +"%Y-%m-%d %H:%M:%S UTC")*
          READMEFOOTER

          echo "‚úÖ Dynamic documentation site created with all available files"

      - name: üîç Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: Basilakis/basilakis.github.io
          token: ${{ secrets.GH_TOKEN }}
          path: target-repo

      - name: üì¶ Install GitHub CLI
        run: |
          echo "Installing GitHub CLI..."
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh

      - name: üöÄ Create Pull Request
        run: |
          # Generate a unique branch name
          BRANCH_NAME="docs-update-$(date +%Y%m%d%H%M%S)"
          echo "Branch name: $BRANCH_NAME"

          # Create a new branch for the changes
          cd target-repo
          git checkout -b $BRANCH_NAME

          # Copy the built files
          echo "Removing existing files..."
          rm -rf * || true

          echo "Copying built documentation site..."
          cp -r ../docs-temp/build/* .

          echo "Contents after copying:"
          ls -la

          # Commit the changes
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          echo "Adding files to git..."
          git add .

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit - documentation is already up to date"
            exit 0
          fi

          echo "Committing changes..."
          git commit -m "Deploy Documentation: $(date)"

          echo "Pushing branch..."
          git push origin $BRANCH_NAME

          echo "Creating pull request..."

          # Create a pull request using GitHub CLI
          gh auth login --with-token <<< "${{ secrets.GH_TOKEN }}"

          # Try to create PR targeting gh-pages branch (where GitHub Pages serves from)
          if ! gh pr create \
            --title "Deploy Documentation: ${{ github.event.head_commit.message }}" \
            --body "This PR was automatically created by the GitHub Actions workflow to update the documentation site. Changes include updates from the Material Kai Vision Platform repository (commit: ${{ github.sha }})." \
            --repo Basilakis/basilakis.github.io \
            --head $BRANCH_NAME \
            --base gh-pages; then
            echo "‚ùå Failed to create PR automatically"
            echo "üîó Create PR manually at: https://github.com/Basilakis/basilakis.github.io/compare/gh-pages...$BRANCH_NAME"
          else
            echo "‚úÖ Pull request created successfully"
          fi