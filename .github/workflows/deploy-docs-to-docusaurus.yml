name: 📚 Deploy Documentation to Docusaurus

on:
  push:
    branches: [main, master]
    paths:
      - 'docs/**'
      - '.github/workflows/deploy-docs-to-docusaurus.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no docs changes'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check_changes.outputs.should_run }}
    steps:
      - name: 🔍 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: 🔧 Check for changes in docs folder
        id: check_changes
        run: |
          if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "Force deployment requested"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get the list of changed files in the most recent commit
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          echo "Changed files in the most recent commit:"
          echo "$CHANGED_FILES"

          # Check if any of the changed files are in the docs folder
          if echo "$CHANGED_FILES" | grep -q "^docs/"; then
            echo "Changes detected in docs folder - will proceed with deployment"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "No changes detected in docs folder - skipping deployment"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  deploy-docs:
    needs: check_changes
    if: needs.check_changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: 🔍 Checkout Material Kai Vision Platform
        uses: actions/checkout@v4

      - name: 📋 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: 🧹 Create directory structure
        run: |
          mkdir -p docs-temp/docs
          mkdir -p docs-temp/build

      - name: 📚 Process documentation files
        run: |
          echo "📚 Processing documentation files..."

          # Copy all documentation
          cp -r docs/* docs-temp/docs/

          # Copy the docs directory directly to the build directory
          cp -r docs-temp/docs/* docs-temp/build/

          echo "✅ Documentation processed. Files copied:"
          find docs-temp/build -name "*.md" | wc -l

      - name: 🔍 Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: Basilakis/basilakis.github.io
          token: ${{ secrets.GH_TOKEN }}
          path: target-repo

      - name: 📦 Install GitHub CLI
        run: |
          echo "Installing GitHub CLI..."
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update
          sudo apt install gh

      - name: 🚀 Create Pull Request
        run: |
          # Generate a unique branch name
          BRANCH_NAME="docs-update-$(date +%Y%m%d%H%M%S)"
          echo "Branch name: $BRANCH_NAME"

          # Create a new branch for the changes
          cd target-repo
          git checkout -b $BRANCH_NAME

          # Copy the built files
          echo "Removing existing files..."
          rm -rf * || true

          echo "Copying documentation files..."
          cp -r ../docs-temp/build/* .

          echo "Contents after copying:"
          ls -la

          # Commit the changes
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          echo "Adding files to git..."
          git add .

          echo "Committing changes..."
          git commit -m "Deploy Documentation: ${{ github.event.head_commit.message }}"

          echo "Pushing branch..."
          git push origin $BRANCH_NAME

          echo "Creating pull request..."
          # Create a pull request using GitHub CLI
          gh auth login --with-token <<< "${{ secrets.GH_TOKEN }}"
          gh pr create \
            --title "Deploy Documentation: ${{ github.event.head_commit.message }}" \
            --body "This PR was automatically created by the GitHub Actions workflow to update the documentation site. Changes include updates from the Material Kai Vision Platform repository (commit: ${{ github.sha }})." \
            --repo Basilakis/basilakis.github.io \
            --head $BRANCH_NAME \
            --base main